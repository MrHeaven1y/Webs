<!DOCTYPE html>
<html>
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>C Autograd in Browser</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            background: #1e1e1e; 
            color: #fff; 
            margin: 0;
            padding-top: 20px;
            /* PREVENT SCROLL BOUNCE ON MOBILE */
            overscroll-behavior: none;
            touch-action: none;
        }
        h1 { margin-bottom: 10px; font-weight: 300; font-size: 1.5rem; text-align: center;}
        
        #canvas-container { 
            position: relative; 
            margin: 20px; 
            border: 4px solid #333;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            /* CRITICAL FOR MOBILE: Fixes layout shifts */
            display: inline-block;
        }
        
        canvas { 
            background: black; 
            cursor: crosshair; 
            display: block;
            /* CRITICAL FOR MOBILE: Disables browser gestures on the canvas */
            touch-action: none; 
            user-select: none;
            -webkit-user-select: none;
            /* Responsive width */
            max-width: 90vw; 
            height: auto;
        }
        
        #controls { margin-bottom: 20px; display: flex; gap: 10px; }
        button { 
            padding: 12px 24px; /* Larger tap targets */
            font-size: 16px; 
            cursor: pointer; 
            background: #007acc; 
            color: white; 
            border: none; 
            border-radius: 4px;
            transition: background 0.2s;
            touch-action: manipulation; /* Improves tap response */
        }
        button:hover { background: #0062a3; }
        button.secondary { background: #444; }
        button.secondary:hover { background: #555; }

        #prediction { 
            font-size: 28px; 
            font-weight: bold; 
            color: #4caf50; 
            min-height: 40px; 
            margin-top: 10px;
        }
        
        #bars { display: flex; gap: 8px; height: 120px; align-items: flex-end; margin-top: 20px; padding-bottom: 20px;}
        .bar-container { display: flex; flex-direction: column; align-items: center; width: 25px; }
        .bar { width: 100%; background: #444; transition: height 0.2s, background 0.2s; border-radius: 3px 3px 0 0; }
        .label { margin-top: 8px; font-size: 12px; color: #aaa; }
    </style>
</head>
<body>

    <h1>Digit Classifier (C + WASM)</h1>
    
    <div id="controls">
        <button class="secondary" onclick="clearCanvas()">Clear</button>
        <button onclick="predict()">Predict</button>
    </div>

    <div id="canvas-container">
        <canvas id="mainCanvas" width="280" height="280"></canvas>
    </div>

    <div id="prediction">Draw a digit...</div>

    <div id="bars"></div>

    <script src="index.js"></script>
    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(() => console.log('SW Registered'))
            .catch((err) => console.error('SW Failed:', err));
    }
    </script>
    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        
        // Drawing State
        let isDrawing = false;

        // Setup drawing style
        ctx.lineWidth = 20;
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'white';

        // --- UNIFIED INPUT HANDLING (MOUSE & TOUCH) ---

        function getPos(e) {
            // Check if touch or mouse
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const rect = canvas.getBoundingClientRect();
            
            // SCALE COORDINATES (Vital for mobile scaling)
            // If CSS shows canvas as 200px but internal width is 280px, 
            // we need to multiply by (280/200) = 1.4
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function startPosition(e) {
            e.preventDefault(); // Stop scrolling/selecting
            isDrawing = true;
            draw(e); // Draw a dot immediately on tap
        }

        function finishedPosition() {
            if(isDrawing) {
                isDrawing = false;
                ctx.beginPath(); // Reset path so next line doesn't connect
                predict(); // Auto-predict on lift
            }
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault(); // Stop scrolling while dragging
            
            const pos = getPos(e);

            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            
            // For smoother lines:
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        // --- EVENT LISTENERS ---

        // Mouse
        canvas.addEventListener('mousedown', startPosition);
        canvas.addEventListener('mouseup', finishedPosition);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseleave', () => isDrawing = false);

        // Touch (Passive: false is required to use preventDefault)
        canvas.addEventListener('touchstart', startPosition, { passive: false });
        canvas.addEventListener('touchend', finishedPosition, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });


        // --- UI & WASM LOGIC REMAIN UNCHANGED BELOW ---

        const barsContainer = document.getElementById('bars');
        const barEls = [];
        for(let i=0; i<10; i++) {
            let div = document.createElement('div');
            div.className = 'bar-container';
            div.innerHTML = `<div class="bar" style="height: 0px;" id="bar-${i}"></div><span class="label">${i}</span>`;
            barsContainer.appendChild(div);
            barEls.push(document.getElementById(`bar-${i}`));
        }

        Module.onRuntimeInitialized = function() {
            console.log("WASM Loaded");
            Module._init_system(); 
        };

        function clearCanvas() {
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            document.getElementById('prediction').innerText = "Draw a digit...";
            barEls.forEach(b => { b.style.height = '0px'; b.style.background = '#444'; });
        }

        function predict() {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 28;
            tempCanvas.height = 28;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Use current canvas dimensions safely
            tempCtx.drawImage(canvas, 0, 0, 28, 28);
            
            const imgData = tempCtx.getImageData(0, 0, 28, 28);
            const pixels = imgData.data; 
            
            const inputPtr = Module._malloc(784 * 8); 
            
            for (let i = 0; i < 784; i++) {
                const val = pixels[i * 4] / 255.0; 
                Module.setValue(inputPtr + i * 8, val, 'double');
            }

            const outputPtr = Module._predict(inputPtr);

            let maxVal = -1;
            let maxIdx = 0;
            for (let i = 0; i < 10; i++) {
                const prob = Module.getValue(outputPtr + i * 8, 'double');
                const height = Math.floor(prob * 100);
                barEls[i].style.height = height + 'px';
                if (prob > maxVal) { maxVal = prob; maxIdx = i; }
            }

            barEls.forEach(b => b.style.background = '#444');
            barEls[maxIdx].style.background = '#4caf50'; 
            document.getElementById('prediction').innerText = `Prediction: ${maxIdx} (${(maxVal*100).toFixed(1)}%)`;

            Module._free(inputPtr);
        }
        
        clearCanvas();
    </script>
</body>
</html>